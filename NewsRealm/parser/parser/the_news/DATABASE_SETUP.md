# Инструкция по созданию базы данных PostgreSQL

## Описание

База данных PostgreSQL создана на основе структуры данных из JSON файла `output.json`, который формирует парсер новостей.

**Важно:** Доступ к базе данных имеет только пользователь `news_database_admin` для обеспечения безопасности.

## Структура таблицы `news`

Таблица содержит следующие поля:

- `id` - SERIAL PRIMARY KEY - уникальный идентификатор записи
- `source` - VARCHAR(50) - источник новости (по умолчанию 'rss')
- `title` - TEXT NOT NULL - заголовок новости
- `description` - TEXT - краткое описание новости
- `maintext` - TEXT - полный текст новости
- `image_url` - TEXT - URL изображения к новости
- `authors` - VARCHAR(500) - автор(ы) новости
- `category` - VARCHAR(100) - категория новости (politics, sport, society и т.д.)
- `date_publish` - DATE - дата публикации новости
- `time_publish` - TIME - время публикации новости
- `language` - VARCHAR(10) - язык новости (по умолчанию 'ru')
- `url` - TEXT NOT NULL UNIQUE - URL оригинальной новости (уникальный)
- `created_at` - TIMESTAMP - время добавления записи в базу данных

## Индексы

### Что такое индексы?

**Индексы** - это специальные структуры данных, которые ускоряют поиск и сортировку в базе данных.

Представьте библиотеку без каталога: чтобы найти книгу, вам нужно просмотреть все полки. Индекс - это как каталог библиотеки: он указывает, где именно находится нужная информация.

### Преимущества индексов:

1. **Ускорение поиска**: запросы с `WHERE` по индексированным полям выполняются намного быстрее
2. **Ускорение сортировки**: `ORDER BY` по индексированным полям работает быстрее
3. **Ускорение JOIN операций**: соединение таблиц по индексированным полям эффективнее

### Недостатки индексов:

1. Занимают дополнительное место на диске
2. Замедляют операции `INSERT`/`UPDATE`/`DELETE` (так как нужно обновлять индекс)

### Индексы в нашей базе данных:

Для оптимизации запросов созданы следующие индексы:

- `idx_news_category` - ускоряет поиск новостей по категориям (например, `SELECT * FROM news WHERE category = 'politics'`)
- `idx_news_date_publish` - ускоряет поиск по датам и сортировку по дате публикации
- `idx_news_language` - ускоряет фильтрацию по языку
- `idx_news_source` - ускоряет поиск по источнику новостей
- `idx_news_created_at` - ускоряет сортировку по времени добавления (`ORDER BY created_at DESC`)
- `idx_news_url` - ускоряет проверку уникальности URL и поиск по URL

**Без индексов:** PostgreSQL пришлось бы просматривать ВСЕ строки таблицы (полное сканирование таблицы)  
**С индексами:** PostgreSQL использует индекс для быстрого поиска нужных строк

## Установка

### Вариант 1: Использование SQL скрипта

1. Убедитесь, что PostgreSQL установлен и запущен
2. Создайте пользователя и базу данных (от имени суперпользователя PostgreSQL):

```bash
# Войдите в psql от имени суперпользователя
sudo -u postgres psql

# Создайте пользователя
CREATE USER tnadmin WITH PASSWORD '12345678';

# Создайте базу данных
CREATE DATABASE the_news OWNER tnadmin ENCODING 'UTF8';

# Выйдите из psql
\q
```

3. Выполните SQL скрипт:

```bash
psql -U tnadmin -d the_news -f create_database.sql
```

### Альтернативный вариант: Автоматическое создание через pipeline

Pipeline автоматически создаст таблицу и индексы при первом запуске парсера, если они еще не существуют. Однако рекомендуется сначала создать пользователя и базу данных вручную для правильной настройки прав доступа.

## Настройка подключения

Настройки подключения к базе данных находятся в файле `settings.py`:

```python
PG_HOST = "localhost"
PG_PORT = 5432
PG_USER = "news_database_admin"
PG_PASSWORD = "secure_password_123"  # ВАЖНО: Измените на пароль, который вы установили
PG_DATABASE = "the_news"
```

**ВАЖНО:** Обязательно измените `PG_PASSWORD` на пароль, который вы установили при создании пользователя `news_database_admin`!

## Безопасность

- Доступ к базе данных имеет только пользователь `news_database_admin`
- Другие пользователи PostgreSQL не имеют доступа к базе данных `the_news`
- Рекомендуется использовать надежный пароль для пользователя `news_database_admin`
- Не храните пароль в открытом виде в системе контроля версий (используйте переменные окружения или файлы конфигурации вне репозитория)

## Использование

После создания базы данных парсер автоматически будет сохранять новости в таблицу `news`. 

Примечание: Pipeline обрабатывает дубликаты - если новость с таким же URL уже существует, она не будет добавлена повторно (используется `ON CONFLICT DO NOTHING`).

## Проверка данных

Для проверки данных в базе можно использовать следующие SQL запросы:

```sql
-- Посмотреть все новости
SELECT * FROM news ORDER BY created_at DESC LIMIT 10;

-- Посчитать количество новостей по категориям
SELECT category, COUNT(*) FROM news GROUP BY category;

-- Найти новости за определенную дату
SELECT * FROM news WHERE date_publish = '2025-10-21';

-- Найти новости определенной категории
SELECT * FROM news WHERE category = 'politics' ORDER BY date_publish DESC;
```
